# architecture_overview.md

## 1. Введение и цели CRM

CRM предназначена для управления крупномасштабными базами телефонных номеров (миллионы записей) и их распределения по проектам, поставщикам и гео, с учетом дней недели и статусов обработки.

Система должна поддерживать конверсионную аналитику по проектам, управление удалёнными проектами, выгрузку и загрузку номеров, а также интеграции по SFTP и с SoftPhone.

## 2. Обзор текущей CRM и ТЗ (конспективно)

Текущая CRM содержит сущности «номер», «проект», «поставщик», «гео», «дни недели», «статусы», а также механизмы конверсии проектов, удалённых проектов и выгрузок номеров.

Интерфейс администратора предоставляет страницы выбора поставщика/гео/дней недели, просмотра конверсии проектов, управления удалёнными проектами и работы с выгрузками/отчётами.

### 2.1 Основные сущности

- **Номера** (phone_numbers)
- **Проекты** (projects)
- **Поставщики** (providers)
- **Гео** (geo / regions / countries)
- **Дни недели** (weekdays / schedules)
- **Статусы обработки номеров** (number_statuses)
- **Удалённые проекты** (deleted_projects или признак в projects)
- **Конверсия проектов** (project_conversion / агрегированные метрики)
- **Выгрузки номеров** (exports / files)
- **Импорты номеров** (imports / sftp_jobs)

### 2.2 Связи между сущностями

- Один проект связан с несколькими номерами (projects 1‑N phone_numbers)
- Каждый номер принадлежит одному проекту и может быть привязан к поставщику и гео
- Проекты могут быть привязаны к одному или нескольким поставщикам и гео через таблицы связей (project_providers, project_geo)
- Дни недели задают расписание активности проекта (project_schedules)
- Статусы номеров отражают этап обработки (новый, в работе, успешно, отказ, недозвон и т.п.)
- Удалённые проекты либо хранятся в отдельной сущности, либо помечаются специальным статусом / флагом is_deleted
- Конверсия проектов рассчитывается на основе статусов номеров и событий (звонки, результаты)

### 2.3 Ключевые страницы текущей CRM

- Страница выбора поставщика/гео/дней недели для проекта (настройка входящего пула номеров и расписания)
- Страница «Конверсия проектов» с метриками по количеству обработанных номеров, результатам и коэффициентам конверсии
- Страница «Удалённые проекты» для просмотра и восстановления/архивирования
- Страницы «Выгрузка номеров» и «Загрузка номеров» для обмена файлами (CSV/XLS) и последующей SFTP‑интеграции
- Страницы управления проектами, поставщиками, гео и справочниками

## 3. Общая архитектура (слои, компоненты, модули)

Система проектируется трехслойной: БД, backend‑API и frontend‑UI.

Для работы с миллионами номеров предусматриваются оптимизированные запросы, индексы и фоновая обработка массовых операций.

### 3.1 Слои

- **База данных**: реляционная СУБД (PostgreSQL) с нормализованной моделью и индексами по ключевым полям (номер, проект, статус, датам)
- **Backend‑API**: stateless веб‑приложение (REST) c аутентификацией, роль‑based доступом и модулями интеграции
- **Frontend‑UI**: одностраничное приложение (SPA) с компонентной архитектурой и поддержкой работы с большими таблицами через серверную пагинацию

### 3.2 Основные модули backend

- Модуль управления номерами
- Модуль управления проектами и их атрибутами (поставщики, гео, дни недели)
- Модуль статусов и конверсии
- Модуль удалённых проектов
- Модуль импорта/выгрузки номеров
- Модуль интеграции по SFTP (импорт/экспорт файлов)
- Точка расширения интеграции с SoftPhone
- Модуль аутентификации, ролей и прав
- Модуль аудит‑логирования

### 3.3 Основные модули frontend

- Интерфейс управления проектами и связями (поставщик/гео/дни недели)
- Таблицы номеров с фильтрами, пагинацией и массовыми действиями
- Экран «Конверсия проектов» с таблицами и агрегированными показателями
- Экран «Удалённые проекты»
- Экран выгрузок/импортов и статусов задач SFTP
- Экран отчётов/аналитики
- Экран аудит‑лога для Администратора

## 4. Выбранный стек(и) и мотивация

### 4.1 Вариант 1 (рекомендуемый)

- **Backend**: Python + Django REST Framework
- **БД**: PostgreSQL
- **Frontend**: React + TypeScript

**Плюсы**: проверенный стек для enterprise‑приложений, удобная ORM, миграции, развитая экосистема для REST и аутентификации, простой старт для небольшой команды. React + TypeScript даёт гибкость, удобное управление состоянием и хорошую поддержку таблиц с серверной пагинацией и фильтрацией.

**Минусы**: Python не самый быстрый на «сырых» вычислениях, что компенсируется правильным индексированием и фоновыми задачами; React требует дисциплины в архитектуре.

### 4.2 Вариант 2

- **Backend**: Node.js (NestJS)
- **БД**: PostgreSQL
- **Frontend**: Vue 3 + TypeScript

**Плюсы**: единый язык (TypeScript) для frontend и backend, структурированный фреймворк NestJS с модульной архитектурой, удобные DTO и валидация. Vue 3 проще вхождения для части разработчиков, хорошо подходит для админ‑панелей.

**Минусы**: меньше строгости, чем у Django в части «из коробки» решений; потребуется больше ручной проработки модели безопасности и миграций.

### 4.3 Сравнительная таблица стеков

| Вариант | Backend | БД | Frontend | Плюсы | Минусы |
|---------|---------|-----|----------|-------|--------|
| 1 | Django REST | PostgreSQL | React+TS | Быстрый старт, ORM, экосистема | Python‑перфоманс, сложность крупного React |
| 2 | NestJS | PostgreSQL | Vue3+TS | Единый язык, модульность | Больше ручной работы по архитектуре |

## 5. Основные сущности и связи (кратко)

- **phone_numbers**: хранение номеров, статус, привязка к проекту, поставщику, гео, технические поля (created_at, updated_at)
- **projects**: параметры проекта, связи с geo, поставщиками, расписанием, флаги активности и удаления
- **providers**: данные поставщика, тип, контактные параметры, статусы
- **geo**: код гео (страна, регион, город) и справочные атрибуты
- **project_schedules**: дни недели и временные окна для проекта
- **number_statuses**: статусы обработки номеров
- **project_conversions / aggregates**: предрасчитанные метрики по проекту
- **imports/exports**: файлы, направления (in/out), статусы, лог ошибок
- **audit_log**: записи о действиях пользователей и системных задач

## 6. Роли и модель доступа

Роли: **Администратор** и **Менеджер**.

Доступ основан на RBAC: права определяются по ролям и типам операций (CRUD, экспорт/импорт, доступ к аудиту, настройкам и интеграциям).

### 6.1 Администратор

- Полный доступ ко всем разделам: проекты, номера, поставщики, гео, статусы, отчеты, выгрузки, интеграции, аудит‑лог
- Управление ролями/пользователями, системными настройками, расписаниями SFTP и точками интеграции SoftPhone

### 6.2 Менеджер

- Доступ к проектам и номерам в рамках разрешённого набора (по фильтру, например, по поставщику или группе)
- Операции: просмотр, изменение статусов номеров, ограниченное создание проектов (по политике), использование выгрузок в пределах разрешений, просмотр базовой конверсии
- Нет доступа к глобальным настройкам, управлению интеграциями, ролями и аудит‑логом (кроме, возможно, личного)

Модель должна поддерживать добавление новых ролей (например, Viewer, Analyst) через конфигурируемые наборы разрешений (permission sets).

## 7. Интеграции: SFTP и SoftPhone (общий обзор)

### 7.1 Модуль SFTP

- Импорт и экспорт файлов с номерами и результатами обработки через SFTP
- Конфигурация удалённых SFTP‑хостов (адрес, порт, логин/ключ, путь к директории)
- Планировщик задач (cron‑подобный) или ручной запуск импорта/экспорта
- Логирование и обработка ошибок: записи в таблицу sftp_jobs и дополнительные лог‑файлы или системный лог

### 7.2 Интеграция с SoftPhone

- Точка интеграции через REST/WebSocket или SDK SoftPhone‑решения
- Привязка событий звонков к номерам и проектам (по номеру телефона, call_id)
- Возможность расширения до онлайнового pop‑up окна при входящем вызове и записи результата звонка в CRM

## 8. Требования к масштабируемости и модернизации

- Эффективная работа с многомиллионными базами номеров: индексы, шардирование по необходимости, batched‑операции, фоновые очереди (Celery/Redis или BullMQ в Node)
- Локальный запуск на одном ПК (docker‑compose с БД и backend/frontend) и возможность переноса в облако/на сервер без радикальной переработки
- Чёткое разделение слоёв и модулей, наличие конфигурационных точек (env‑переменные, настройки БД и интеграций) для дальнейшей модернизации

## 9. Использование ИИ‑помощников

- Генерация типового кода (контроллеры, репозитории, DTO, компоненты UI) по описанной архитектуре и схемам
- Автоматическая генерация миграций и SQL‑запросов по моделям данных (с последующей ручной проверкой)
- Написание модульных и интеграционных тестов (шаблоны тест‑кейсов) и обновление .md‑документации при изменении API
- Все решения и код, предложенные ИИ, проходят ручное ревью и тестирование перед включением в основной код
